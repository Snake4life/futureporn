---

- name: Wait up to 300 seconds for SSH to be up
  wait_for_connection:
    timeout: 300

- name: set hostname
  ansible.builtin.hostname:
    name: "{{ ansible_facts['nodename'] }}"

- name: Install dependencies
  apt:
    pkg: 
      - python3
      - python3-pip
      - mosh 
      - mg 
      - screen 
      - git
      - magic-wormhole
      - ffmpeg
      - rclone
    state: present
    update_cache: yes

- name: Configure rclone
  ansible.builtin.template:
    src: templates/rclone.conf.j2
    dest: /root/.config/rclone/rclone.conf
    owner: root
    group: root
    mode: '0600'

- name: Download screen configuration
  git:
    repo: 'https://github.com/insanity54/dotfiles'
    dest: /root/dotfiles

- name: Configure screen
  copy:
    src: /root/dotfiles/.screenrc
    dest: /root/.screenrc
    remote_src: yes

- name: Install & update youtube-dl
  pip:
    name: youtube-dl
    state: latest

- name: Install & update voddo
  git:
    repo: 'https://github.com/insanity54/voddo'
    dest: /root/voddo

- name: Install voddo system service
  ansible.builtin.template:
    src: templates/voddo.service.j2
    dest: /etc/systemd/system/voddo.service
    owner: root
    group: root
    mode: '0755'
  notify: 
    - restart voddo

- name: Enable voddo system service
  systemd:
    name: voddo
    state: started
    daemon_reload: yes
    enabled: yes
  notify:
    - restart voddo

- name: Enable journalctl persistent logging
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    search_string: '^Storage='
    line: 'Storage=persistent'
    state: present
  notify: 
    - restart systemd-journald


